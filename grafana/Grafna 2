[root@drlogging2 node2]# cat docker-compose.yml
# =============================================================================
# LOKI NODE 2 - HIGH AVAILABILITY DOCKER COMPOSE
# =============================================================================
# High availability configuration with NetAPP S3 storage

services:

  # Loki Distributor Secondary 1
  distributor-secondary-1:
    image: ${LOKI_IMAGE_TAG}
    container_name: loki-distributor-secondary-1-node2
    command: [
      "-config.file=/etc/loki/loki-config.yaml",
      "-config.expand-env=true",
      "-target=distributor"
    ]
    volumes:
      - ./loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem:/etc/ssl/certs/ca-certificates.crt:ro
      - /root/.aws:/root/.aws:ro
    network_mode: host
    restart: unless-stopped
    environment:
      - HTTP_PORT=${DISTRIBUTOR_SECONDARY_1_HTTP_PORT}
      - GRPC_PORT=${DISTRIBUTOR_SECONDARY_1_GRPC_PORT}
      - MEMBERLIST_PORT=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_1=${MEMBERLIST_PORT_INGESTER_PRIMARY_1}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_2=${MEMBERLIST_PORT_INGESTER_PRIMARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND=${MEMBERLIST_PORT_QUERY_FRONTEND}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_1=${MEMBERLIST_PORT_QUERIER_PRIMARY_1}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_2=${MEMBERLIST_PORT_QUERIER_PRIMARY_2}
      - MEMBERLIST_PORT_COMPACTOR=${MEMBERLIST_PORT_COMPACTOR}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_1=${MEMBERLIST_PORT_INGESTER_SECONDARY_1}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_2=${MEMBERLIST_PORT_INGESTER_SECONDARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND_NODE2=${MEMBERLIST_PORT_QUERY_FRONTEND_NODE2}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_1=${MEMBERLIST_PORT_QUERIER_SECONDARY_1}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_2=${MEMBERLIST_PORT_QUERIER_SECONDARY_2}
      - MEMBERLIST_PORT_COMPACTOR_NODE2=${MEMBERLIST_PORT_COMPACTOR_NODE2}
      - INSTANCE_IP=${INSTANCE_IP}
      - NODE1_IP=${NODE1_IP}
      - NODE2_IP=${NODE2_IP}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_REGION=${S3_REGION}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE}
      - S3_INSECURE= true
      - LOKI_DATA_PATH=${LOKI_DATA_PATH}
      - WAL_PATH=${WAL_PATH}
      - TSDB_PATH=${TSDB_PATH}
      - COMPACTOR_PATH=${COMPACTOR_PATH}
      - REPLICATION_FACTOR=${REPLICATION_FACTOR}
      - CHUNK_IDLE_PERIOD=${CHUNK_IDLE_PERIOD}
      - CHUNK_RETAIN_PERIOD=${CHUNK_RETAIN_PERIOD}
      - MAX_CHUNK_AGE=${MAX_CHUNK_AGE}
      - MAX_CONCURRENT_QUERIES=${MAX_CONCURRENT_QUERIES}
      - QUERY_PARALLELISM=${QUERY_PARALLELISM}
      - MAX_STREAMS_PER_USER=${MAX_STREAMS_PER_USER}
      - MAX_LINE_SIZE=${MAX_LINE_SIZE}
      - MAX_ENTRIES_LIMIT_PER_QUERY=${MAX_ENTRIES_LIMIT_PER_QUERY}
      - LOG_LEVEL=${LOG_LEVEL}
      - LOG_FORMAT=${LOG_FORMAT}
      - AUTH_ENABLED=${AUTH_ENABLED}
      - RING_HEARTBEAT_TIMEOUT=${RING_HEARTBEAT_TIMEOUT}
      - INGESTION_RATE_MB=${INGESTION_RATE_MB}
      - INGESTION_BURST_SIZE_MB=${INGESTION_BURST_SIZE_MB}
      - PER_STREAM_RATE_LIMIT_BYTES=${PER_STREAM_RATE_LIMIT_BYTES}
      - PER_STREAM_RATE_LIMIT_BURST_BYTES=${PER_STREAM_RATE_LIMIT_BURST_BYTES}
      - MAX_QUERY_SERIES=${MAX_QUERY_SERIES}
      - MAX_QUERY_LENGTH=${MAX_QUERY_LENGTH}
      - MAX_QUERY_LOOKBACK=${MAX_QUERY_LOOKBACK}
      - MAX_CACHE_FRESHNESS_PER_QUERY=${MAX_CACHE_FRESHNESS_PER_QUERY}
      - SPLIT_QUERIES_BY_INTERVAL=${SPLIT_QUERIES_BY_INTERVAL}
      - MAX_STREAMS_MATCHERS_PER_QUERY=${MAX_STREAMS_MATCHERS_PER_QUERY}
      - MAX_CONCURRENT_TAIL_REQUESTS=${MAX_CONCURRENT_TAIL_REQUESTS}
      - MAX_GLOBAL_STREAMS_PER_USER=${MAX_GLOBAL_STREAMS_PER_USER}
      - REPLAY_MEMORY_CEILING=${REPLAY_MEMORY_CEILING}
      - QUERY_INGESTERS_WITHIN=${QUERY_INGESTERS_WITHIN}
      - MAX_OUTSTANDING_PER_TENANT=${MAX_OUTSTANDING_PER_TENANT}

  # Loki Distributor Secondary 2
  distributor-secondary-2:
    image: ${LOKI_IMAGE_TAG}
    container_name: loki-distributor-secondary-2-node2
    command: [
      "-config.file=/etc/loki/loki-config.yaml",
      "-config.expand-env=true",
      "-target=distributor"
    ]
    volumes:
      - ./loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem:/etc/ssl/certs/ca-certificates.crt:ro
      - /root/.aws:/root/.aws:ro
    network_mode: host
    restart: unless-stopped
    environment:
      - HTTP_PORT=${DISTRIBUTOR_SECONDARY_2_HTTP_PORT}
      - GRPC_PORT=${DISTRIBUTOR_SECONDARY_2_GRPC_PORT}
      - MEMBERLIST_PORT=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_1=${MEMBERLIST_PORT_INGESTER_PRIMARY_1}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_2=${MEMBERLIST_PORT_INGESTER_PRIMARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND=${MEMBERLIST_PORT_QUERY_FRONTEND}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_1=${MEMBERLIST_PORT_QUERIER_PRIMARY_1}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_2=${MEMBERLIST_PORT_QUERIER_PRIMARY_2}
      - MEMBERLIST_PORT_COMPACTOR=${MEMBERLIST_PORT_COMPACTOR}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_1=${MEMBERLIST_PORT_INGESTER_SECONDARY_1}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_2=${MEMBERLIST_PORT_INGESTER_SECONDARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND_NODE2=${MEMBERLIST_PORT_QUERY_FRONTEND_NODE2}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_1=${MEMBERLIST_PORT_QUERIER_SECONDARY_1}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_2=${MEMBERLIST_PORT_QUERIER_SECONDARY_2}
      - MEMBERLIST_PORT_COMPACTOR_NODE2=${MEMBERLIST_PORT_COMPACTOR_NODE2}
      - INSTANCE_IP=${INSTANCE_IP}
      - NODE1_IP=${NODE1_IP}
      - NODE2_IP=${NODE2_IP}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_REGION=${S3_REGION}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE}
      - S3_INSECURE= true
      - LOKI_DATA_PATH=${LOKI_DATA_PATH}
      - WAL_PATH=${WAL_PATH}
      - TSDB_PATH=${TSDB_PATH}
      - COMPACTOR_PATH=${COMPACTOR_PATH}
      - REPLICATION_FACTOR=${REPLICATION_FACTOR}
      - CHUNK_IDLE_PERIOD=${CHUNK_IDLE_PERIOD}
      - CHUNK_RETAIN_PERIOD=${CHUNK_RETAIN_PERIOD}
      - MAX_CHUNK_AGE=${MAX_CHUNK_AGE}
      - MAX_CONCURRENT_QUERIES=${MAX_CONCURRENT_QUERIES}
      - QUERY_PARALLELISM=${QUERY_PARALLELISM}
      - MAX_STREAMS_PER_USER=${MAX_STREAMS_PER_USER}
      - MAX_LINE_SIZE=${MAX_LINE_SIZE}
      - MAX_ENTRIES_LIMIT_PER_QUERY=${MAX_ENTRIES_LIMIT_PER_QUERY}
      - LOG_LEVEL=${LOG_LEVEL}
      - LOG_FORMAT=${LOG_FORMAT}
      - AUTH_ENABLED=${AUTH_ENABLED}
      - RING_HEARTBEAT_TIMEOUT=${RING_HEARTBEAT_TIMEOUT}
      - INGESTION_RATE_MB=${INGESTION_RATE_MB}
      - INGESTION_BURST_SIZE_MB=${INGESTION_BURST_SIZE_MB}
      - PER_STREAM_RATE_LIMIT_BYTES=${PER_STREAM_RATE_LIMIT_BYTES}
      - PER_STREAM_RATE_LIMIT_BURST_BYTES=${PER_STREAM_RATE_LIMIT_BURST_BYTES}
      - MAX_QUERY_SERIES=${MAX_QUERY_SERIES}
      - MAX_QUERY_LENGTH=${MAX_QUERY_LENGTH}
      - MAX_QUERY_LOOKBACK=${MAX_QUERY_LOOKBACK}
      - MAX_CACHE_FRESHNESS_PER_QUERY=${MAX_CACHE_FRESHNESS_PER_QUERY}
      - SPLIT_QUERIES_BY_INTERVAL=${SPLIT_QUERIES_BY_INTERVAL}
      - MAX_STREAMS_MATCHERS_PER_QUERY=${MAX_STREAMS_MATCHERS_PER_QUERY}
      - MAX_CONCURRENT_TAIL_REQUESTS=${MAX_CONCURRENT_TAIL_REQUESTS}
      - MAX_GLOBAL_STREAMS_PER_USER=${MAX_GLOBAL_STREAMS_PER_USER}
      - REPLAY_MEMORY_CEILING=${REPLAY_MEMORY_CEILING}
      - QUERY_INGESTERS_WITHIN=${QUERY_INGESTERS_WITHIN}
      - MAX_OUTSTANDING_PER_TENANT=${MAX_OUTSTANDING_PER_TENANT}

  # Loki Ingester Secondary 1
  ingester-secondary-1:
    image: ${LOKI_IMAGE_TAG}
    container_name: loki-ingester-secondary-1-node2
    command: [
      "-config.file=/etc/loki/loki-config.yaml",
      "-config.expand-env=true",
      "-target=ingester"
    ]
    volumes:
      - ./loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - ./data/loki/ingestor-1:/data/loki
#      - /etc/pki/tls/certs/s3store-a9cl2-dr.bank.sbi.crt:/etc/pki/tls/certs/s3store-a9cl2-dr.bank.sbi.crt:ro
      - /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem:/etc/ssl/certs/ca-certificates.crt:ro
      - /root/.aws:/root/.aws:ro
    network_mode: host
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --spider -q http://localhost:${INGESTER_SECONDARY_1_HTTP_PORT}/ready && wget -q -O- http://localhost:${INGESTER_SECONDARY_1_HTTP_PORT}/ring | grep -q 'ACTIVE'"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    environment:
      - HTTP_PORT=${INGESTER_SECONDARY_1_HTTP_PORT}
      - GRPC_PORT=${INGESTER_SECONDARY_1_GRPC_PORT}
      - MEMBERLIST_PORT=${MEMBERLIST_PORT_INGESTER_SECONDARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_1=${MEMBERLIST_PORT_INGESTER_PRIMARY_1}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_2=${MEMBERLIST_PORT_INGESTER_PRIMARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND=${MEMBERLIST_PORT_QUERY_FRONTEND}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_1=${MEMBERLIST_PORT_QUERIER_PRIMARY_1}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_2=${MEMBERLIST_PORT_QUERIER_PRIMARY_2}
      - MEMBERLIST_PORT_COMPACTOR=${MEMBERLIST_PORT_COMPACTOR}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_1=${MEMBERLIST_PORT_INGESTER_SECONDARY_1}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_2=${MEMBERLIST_PORT_INGESTER_SECONDARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND_NODE2=${MEMBERLIST_PORT_QUERY_FRONTEND_NODE2}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_1=${MEMBERLIST_PORT_QUERIER_SECONDARY_1}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_2=${MEMBERLIST_PORT_QUERIER_SECONDARY_2}
      - MEMBERLIST_PORT_COMPACTOR_NODE2=${MEMBERLIST_PORT_COMPACTOR_NODE2}
      - INSTANCE_IP=${INSTANCE_IP}
      - NODE1_IP=${NODE1_IP}
      - NODE2_IP=${NODE2_IP}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_REGION=${S3_REGION}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE}
      - S3_INSECURE=${S3_INSECURE}
      - LOKI_DATA_PATH=${LOKI_DATA_PATH}
      - WAL_PATH=${WAL_PATH}
      - TSDB_PATH=${TSDB_PATH}
      - COMPACTOR_PATH=${COMPACTOR_PATH}
      - REPLICATION_FACTOR=${REPLICATION_FACTOR}
      - CHUNK_IDLE_PERIOD=${CHUNK_IDLE_PERIOD}
      - CHUNK_RETAIN_PERIOD=${CHUNK_RETAIN_PERIOD}
      - MAX_CHUNK_AGE=${MAX_CHUNK_AGE}
      - MAX_CONCURRENT_QUERIES=${MAX_CONCURRENT_QUERIES}
      - QUERY_PARALLELISM=${QUERY_PARALLELISM}
      - MAX_STREAMS_PER_USER=${MAX_STREAMS_PER_USER}
      - MAX_LINE_SIZE=${MAX_LINE_SIZE}
      - MAX_ENTRIES_LIMIT_PER_QUERY=${MAX_ENTRIES_LIMIT_PER_QUERY}
      - LOG_LEVEL=${LOG_LEVEL}
      - LOG_FORMAT=${LOG_FORMAT}
      - AUTH_ENABLED=${AUTH_ENABLED}
      - RING_HEARTBEAT_TIMEOUT=${RING_HEARTBEAT_TIMEOUT}
      - INGESTION_RATE_MB=${INGESTION_RATE_MB}
      - INGESTION_BURST_SIZE_MB=${INGESTION_BURST_SIZE_MB}
      - PER_STREAM_RATE_LIMIT_BYTES=${PER_STREAM_RATE_LIMIT_BYTES}
      - PER_STREAM_RATE_LIMIT_BURST_BYTES=${PER_STREAM_RATE_LIMIT_BURST_BYTES}
      - MAX_QUERY_SERIES=${MAX_QUERY_SERIES}
      - MAX_QUERY_LENGTH=${MAX_QUERY_LENGTH}
      - MAX_QUERY_LOOKBACK=${MAX_QUERY_LOOKBACK}
      - MAX_CACHE_FRESHNESS_PER_QUERY=${MAX_CACHE_FRESHNESS_PER_QUERY}
      - SPLIT_QUERIES_BY_INTERVAL=${SPLIT_QUERIES_BY_INTERVAL}
      - MAX_STREAMS_MATCHERS_PER_QUERY=${MAX_STREAMS_MATCHERS_PER_QUERY}
      - MAX_CONCURRENT_TAIL_REQUESTS=${MAX_CONCURRENT_TAIL_REQUESTS}
      - MAX_GLOBAL_STREAMS_PER_USER=${MAX_GLOBAL_STREAMS_PER_USER}
      - REPLAY_MEMORY_CEILING=${REPLAY_MEMORY_CEILING}
      - QUERY_INGESTERS_WITHIN=${QUERY_INGESTERS_WITHIN}
      - MAX_OUTSTANDING_PER_TENANT=${MAX_OUTSTANDING_PER_TENANT}

  # Loki Ingester Secondary 2
  ingester-secondary-2:
    image: ${LOKI_IMAGE_TAG}
    container_name: loki-ingester-secondary-2-node2
    command: [
      "-config.file=/etc/loki/loki-config.yaml",
      "-config.expand-env=true",
      "-target=ingester"
    ]
    volumes:
      - ./loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - ./data/loki/ingestor-2:/data/loki
#      - /etc/pki/tls/certs/s3store-a9cl2-dr.bank.sbi.crt:/etc/pki/tls/certs/s3store-a9cl2-dr.bank.sbi.crt:ro
      - /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem:/etc/ssl/certs/ca-certificates.crt:ro
      - /root/.aws:/root/.aws:ro
    network_mode: host
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --spider -q http://localhost:${INGESTER_SECONDARY_2_HTTP_PORT}/ready && wget -q -O- http://localhost:${INGESTER_SECONDARY_2_HTTP_PORT}/ring | grep -q 'ACTIVE'"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    environment:
      - HTTP_PORT=${INGESTER_SECONDARY_2_HTTP_PORT}
      - GRPC_PORT=${INGESTER_SECONDARY_2_GRPC_PORT}
      - MEMBERLIST_PORT=${MEMBERLIST_PORT_INGESTER_SECONDARY_2}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_1=${MEMBERLIST_PORT_INGESTER_PRIMARY_1}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_2=${MEMBERLIST_PORT_INGESTER_PRIMARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND=${MEMBERLIST_PORT_QUERY_FRONTEND}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_1=${MEMBERLIST_PORT_QUERIER_PRIMARY_1}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_2=${MEMBERLIST_PORT_QUERIER_PRIMARY_2}
      - MEMBERLIST_PORT_COMPACTOR=${MEMBERLIST_PORT_COMPACTOR}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_1=${MEMBERLIST_PORT_INGESTER_SECONDARY_1}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_2=${MEMBERLIST_PORT_INGESTER_SECONDARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND_NODE2=${MEMBERLIST_PORT_QUERY_FRONTEND_NODE2}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_1=${MEMBERLIST_PORT_QUERIER_SECONDARY_1}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_2=${MEMBERLIST_PORT_QUERIER_SECONDARY_2}
      - MEMBERLIST_PORT_COMPACTOR_NODE2=${MEMBERLIST_PORT_COMPACTOR_NODE2}
      - INSTANCE_IP=${INSTANCE_IP}
      - NODE1_IP=${NODE1_IP}
      - NODE2_IP=${NODE2_IP}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_REGION=${S3_REGION}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE}
      - S3_INSECURE=${S3_INSECURE}
      - LOKI_DATA_PATH=${LOKI_DATA_PATH}
      - WAL_PATH=${WAL_PATH}
      - TSDB_PATH=${TSDB_PATH}
      - COMPACTOR_PATH=${COMPACTOR_PATH}
      - REPLICATION_FACTOR=${REPLICATION_FACTOR}
      - CHUNK_IDLE_PERIOD=${CHUNK_IDLE_PERIOD}
      - CHUNK_RETAIN_PERIOD=${CHUNK_RETAIN_PERIOD}
      - MAX_CHUNK_AGE=${MAX_CHUNK_AGE}
      - MAX_CONCURRENT_QUERIES=${MAX_CONCURRENT_QUERIES}
      - QUERY_PARALLELISM=${QUERY_PARALLELISM}
      - MAX_STREAMS_PER_USER=${MAX_STREAMS_PER_USER}
      - MAX_LINE_SIZE=${MAX_LINE_SIZE}
      - MAX_ENTRIES_LIMIT_PER_QUERY=${MAX_ENTRIES_LIMIT_PER_QUERY}
      - LOG_LEVEL=${LOG_LEVEL}
      - LOG_FORMAT=${LOG_FORMAT}
      - AUTH_ENABLED=${AUTH_ENABLED}
      - RING_HEARTBEAT_TIMEOUT=${RING_HEARTBEAT_TIMEOUT}
      - INGESTION_RATE_MB=${INGESTION_RATE_MB}
      - INGESTION_BURST_SIZE_MB=${INGESTION_BURST_SIZE_MB}
      - PER_STREAM_RATE_LIMIT_BYTES=${PER_STREAM_RATE_LIMIT_BYTES}
      - PER_STREAM_RATE_LIMIT_BURST_BYTES=${PER_STREAM_RATE_LIMIT_BURST_BYTES}
      - MAX_QUERY_SERIES=${MAX_QUERY_SERIES}
      - MAX_QUERY_LENGTH=${MAX_QUERY_LENGTH}
      - MAX_QUERY_LOOKBACK=${MAX_QUERY_LOOKBACK}
      - MAX_CACHE_FRESHNESS_PER_QUERY=${MAX_CACHE_FRESHNESS_PER_QUERY}
      - SPLIT_QUERIES_BY_INTERVAL=${SPLIT_QUERIES_BY_INTERVAL}
      - MAX_STREAMS_MATCHERS_PER_QUERY=${MAX_STREAMS_MATCHERS_PER_QUERY}
      - MAX_CONCURRENT_TAIL_REQUESTS=${MAX_CONCURRENT_TAIL_REQUESTS}
      - MAX_GLOBAL_STREAMS_PER_USER=${MAX_GLOBAL_STREAMS_PER_USER}
      - REPLAY_MEMORY_CEILING=${REPLAY_MEMORY_CEILING}
      - QUERY_INGESTERS_WITHIN=${QUERY_INGESTERS_WITHIN}
      - MAX_OUTSTANDING_PER_TENANT=${MAX_OUTSTANDING_PER_TENANT}

  # Loki Query Frontend
  query-frontend:
    image: ${LOKI_IMAGE_TAG}
    container_name: loki-query-frontend-node2
    command: [
      "-config.file=/etc/loki/loki-config.yaml",
      "-config.expand-env=true",
      "-target=query-frontend"
    ]
    volumes:
      - ./loki-config.yaml:/etc/loki/loki-config.yaml:ro
#      - /etc/pki/tls/certs/s3store-a9cl2-dr.bank.sbi.crt:/etc/pki/tls/certs/s3store-a9cl2-dr.bank.sbi.crt:ro
      - /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem:/etc/ssl/certs/ca-certificates.crt:ro
      - /root/.aws:/root/.aws:ro
    network_mode: host
    restart: unless-stopped
    environment:
      - HTTP_PORT=${QUERY_FRONTEND_HTTP_PORT}
      - GRPC_PORT=${QUERY_FRONTEND_GRPC_PORT}
      - MEMBERLIST_PORT=${MEMBERLIST_PORT_QUERY_FRONTEND_NODE2}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_1=${MEMBERLIST_PORT_INGESTER_PRIMARY_1}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_2=${MEMBERLIST_PORT_INGESTER_PRIMARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND=${MEMBERLIST_PORT_QUERY_FRONTEND}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_1=${MEMBERLIST_PORT_QUERIER_PRIMARY_1}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_2=${MEMBERLIST_PORT_QUERIER_PRIMARY_2}
      - MEMBERLIST_PORT_COMPACTOR=${MEMBERLIST_PORT_COMPACTOR}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_1=${MEMBERLIST_PORT_INGESTER_SECONDARY_1}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_2=${MEMBERLIST_PORT_INGESTER_SECONDARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND_NODE2=${MEMBERLIST_PORT_QUERY_FRONTEND_NODE2}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_1=${MEMBERLIST_PORT_QUERIER_SECONDARY_1}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_2=${MEMBERLIST_PORT_QUERIER_SECONDARY_2}
      - MEMBERLIST_PORT_COMPACTOR_NODE2=${MEMBERLIST_PORT_COMPACTOR_NODE2}
      - INSTANCE_IP=${INSTANCE_IP}
      - NODE1_IP=${NODE1_IP}
      - NODE2_IP=${NODE2_IP}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_REGION=${S3_REGION}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE}
      - S3_INSECURE=${S3_INSECURE}
      - LOKI_DATA_PATH=${LOKI_DATA_PATH}
      - WAL_PATH=${WAL_PATH}
      - TSDB_PATH=${TSDB_PATH}
      - COMPACTOR_PATH=${COMPACTOR_PATH}
      - REPLICATION_FACTOR=${REPLICATION_FACTOR}
      - CHUNK_IDLE_PERIOD=${CHUNK_IDLE_PERIOD}
      - CHUNK_RETAIN_PERIOD=${CHUNK_RETAIN_PERIOD}
      - MAX_CHUNK_AGE=${MAX_CHUNK_AGE}
      - MAX_CONCURRENT_QUERIES=${MAX_CONCURRENT_QUERIES}
      - QUERY_PARALLELISM=${QUERY_PARALLELISM}
      - MAX_STREAMS_PER_USER=${MAX_STREAMS_PER_USER}
      - MAX_LINE_SIZE=${MAX_LINE_SIZE}
      - MAX_ENTRIES_LIMIT_PER_QUERY=${MAX_ENTRIES_LIMIT_PER_QUERY}
      - LOG_LEVEL=${LOG_LEVEL}
      - LOG_FORMAT=${LOG_FORMAT}
      - AUTH_ENABLED=${AUTH_ENABLED}
      - RING_HEARTBEAT_TIMEOUT=${RING_HEARTBEAT_TIMEOUT}
      - INGESTION_RATE_MB=${INGESTION_RATE_MB}
      - INGESTION_BURST_SIZE_MB=${INGESTION_BURST_SIZE_MB}
      - PER_STREAM_RATE_LIMIT_BYTES=${PER_STREAM_RATE_LIMIT_BYTES}
      - PER_STREAM_RATE_LIMIT_BURST_BYTES=${PER_STREAM_RATE_LIMIT_BURST_BYTES}
      - MAX_QUERY_SERIES=${MAX_QUERY_SERIES}
      - MAX_QUERY_LENGTH=${MAX_QUERY_LENGTH}
      - MAX_QUERY_LOOKBACK=${MAX_QUERY_LOOKBACK}
      - MAX_CACHE_FRESHNESS_PER_QUERY=${MAX_CACHE_FRESHNESS_PER_QUERY}
      - SPLIT_QUERIES_BY_INTERVAL=${SPLIT_QUERIES_BY_INTERVAL}
      - MAX_STREAMS_MATCHERS_PER_QUERY=${MAX_STREAMS_MATCHERS_PER_QUERY}
      - MAX_CONCURRENT_TAIL_REQUESTS=${MAX_CONCURRENT_TAIL_REQUESTS}
      - MAX_GLOBAL_STREAMS_PER_USER=${MAX_GLOBAL_STREAMS_PER_USER}
      - REPLAY_MEMORY_CEILING=${REPLAY_MEMORY_CEILING}
      - QUERY_INGESTERS_WITHIN=${QUERY_INGESTERS_WITHIN}
      - MAX_OUTSTANDING_PER_TENANT=${MAX_OUTSTANDING_PER_TENANT}

  # Loki Querier Secondary 1
  querier-secondary-1:
    image: ${LOKI_IMAGE_TAG}
    container_name: loki-querier-secondary-1-node2
    command: [
      "-config.file=/etc/loki/loki-config.yaml",
      "-config.expand-env=true",
      "-target=querier"
    ]
    volumes:
      - ./loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - ./data/loki/querier-1:/data/loki
#      - /etc/pki/tls/certs/s3store-a9cl2-dr.bank.sbi.crt:/etc/pki/tls/certs/s3store-a9cl2-dr.bank.sbi.crt:ro
      - /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem:/etc/ssl/certs/ca-certificates.crt:ro
      - /root/.aws:/root/.aws:ro
    network_mode: host
    restart: unless-stopped
    environment:
      - HTTP_PORT=${QUERIER_SECONDARY_1_HTTP_PORT}
      - GRPC_PORT=${QUERIER_SECONDARY_1_GRPC_PORT}
      - MEMBERLIST_PORT=${MEMBERLIST_PORT_QUERIER_SECONDARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_1=${MEMBERLIST_PORT_INGESTER_PRIMARY_1}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_2=${MEMBERLIST_PORT_INGESTER_PRIMARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND=${MEMBERLIST_PORT_QUERY_FRONTEND}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_1=${MEMBERLIST_PORT_QUERIER_PRIMARY_1}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_2=${MEMBERLIST_PORT_QUERIER_PRIMARY_2}
      - MEMBERLIST_PORT_COMPACTOR=${MEMBERLIST_PORT_COMPACTOR}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_1=${MEMBERLIST_PORT_INGESTER_SECONDARY_1}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_2=${MEMBERLIST_PORT_INGESTER_SECONDARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND_NODE2=${MEMBERLIST_PORT_QUERY_FRONTEND_NODE2}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_1=${MEMBERLIST_PORT_QUERIER_SECONDARY_1}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_2=${MEMBERLIST_PORT_QUERIER_SECONDARY_2}
      - MEMBERLIST_PORT_COMPACTOR_NODE2=${MEMBERLIST_PORT_COMPACTOR_NODE2}
      - QUERY_FRONTEND_GRPC_PORT=${QUERY_FRONTEND_GRPC_PORT}
      - INSTANCE_IP=${INSTANCE_IP}
      - NODE1_IP=${NODE1_IP}
      - NODE2_IP=${NODE2_IP}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_REGION=${S3_REGION}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE}
      - S3_INSECURE=${S3_INSECURE}
      - LOKI_DATA_PATH=${LOKI_DATA_PATH}
      - WAL_PATH=${WAL_PATH}
      - TSDB_PATH=${TSDB_PATH}
      - COMPACTOR_PATH=${COMPACTOR_PATH}
      - REPLICATION_FACTOR=${REPLICATION_FACTOR}
      - CHUNK_IDLE_PERIOD=${CHUNK_IDLE_PERIOD}
      - CHUNK_RETAIN_PERIOD=${CHUNK_RETAIN_PERIOD}
      - MAX_CHUNK_AGE=${MAX_CHUNK_AGE}
      - MAX_CONCURRENT_QUERIES=${MAX_CONCURRENT_QUERIES}
      - QUERY_PARALLELISM=${QUERY_PARALLELISM}
      - MAX_STREAMS_PER_USER=${MAX_STREAMS_PER_USER}
      - MAX_LINE_SIZE=${MAX_LINE_SIZE}
      - MAX_ENTRIES_LIMIT_PER_QUERY=${MAX_ENTRIES_LIMIT_PER_QUERY}
      - LOG_LEVEL=${LOG_LEVEL}
      - LOG_FORMAT=${LOG_FORMAT}
      - AUTH_ENABLED=${AUTH_ENABLED}
      - RING_HEARTBEAT_TIMEOUT=${RING_HEARTBEAT_TIMEOUT}
      - INGESTION_RATE_MB=${INGESTION_RATE_MB}
      - INGESTION_BURST_SIZE_MB=${INGESTION_BURST_SIZE_MB}
      - PER_STREAM_RATE_LIMIT_BYTES=${PER_STREAM_RATE_LIMIT_BYTES}
      - PER_STREAM_RATE_LIMIT_BURST_BYTES=${PER_STREAM_RATE_LIMIT_BURST_BYTES}
      - MAX_QUERY_SERIES=${MAX_QUERY_SERIES}
      - MAX_QUERY_LENGTH=${MAX_QUERY_LENGTH}
      - MAX_QUERY_LOOKBACK=${MAX_QUERY_LOOKBACK}
      - MAX_CACHE_FRESHNESS_PER_QUERY=${MAX_CACHE_FRESHNESS_PER_QUERY}
      - SPLIT_QUERIES_BY_INTERVAL=${SPLIT_QUERIES_BY_INTERVAL}
      - MAX_STREAMS_MATCHERS_PER_QUERY=${MAX_STREAMS_MATCHERS_PER_QUERY}
      - MAX_CONCURRENT_TAIL_REQUESTS=${MAX_CONCURRENT_TAIL_REQUESTS}
      - MAX_GLOBAL_STREAMS_PER_USER=${MAX_GLOBAL_STREAMS_PER_USER}
      - REPLAY_MEMORY_CEILING=${REPLAY_MEMORY_CEILING}
      - QUERY_INGESTERS_WITHIN=${QUERY_INGESTERS_WITHIN}
      - MAX_OUTSTANDING_PER_TENANT=${MAX_OUTSTANDING_PER_TENANT}

  # Loki Querier Secondary 2
  querier-secondary-2:
    image: ${LOKI_IMAGE_TAG}
    container_name: loki-querier-secondary-2-node2
    command: [
      "-config.file=/etc/loki/loki-config.yaml",
      "-config.expand-env=true",
      "-target=querier"
    ]
    volumes:
      - ./loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - ./data/loki/querier-2:/data/loki
#      - /etc/pki/tls/certs/s3store-a9cl2-dr.bank.sbi.crt:/etc/pki/tls/certs/s3store-a9cl2-dr.bank.sbi.crt:ro
      - /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem:/etc/ssl/certs/ca-certificates.crt:ro
      - /root/.aws:/root/.aws:ro
    network_mode: host
    restart: unless-stopped
    environment:
      - HTTP_PORT=${QUERIER_SECONDARY_2_HTTP_PORT}
      - GRPC_PORT=${QUERIER_SECONDARY_2_GRPC_PORT}
      - MEMBERLIST_PORT=${MEMBERLIST_PORT_QUERIER_SECONDARY_2}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_1=${MEMBERLIST_PORT_INGESTER_PRIMARY_1}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_2=${MEMBERLIST_PORT_INGESTER_PRIMARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND=${MEMBERLIST_PORT_QUERY_FRONTEND}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_1=${MEMBERLIST_PORT_QUERIER_PRIMARY_1}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_2=${MEMBERLIST_PORT_QUERIER_PRIMARY_2}
      - MEMBERLIST_PORT_COMPACTOR=${MEMBERLIST_PORT_COMPACTOR}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_1=${MEMBERLIST_PORT_INGESTER_SECONDARY_1}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_2=${MEMBERLIST_PORT_INGESTER_SECONDARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND_NODE2=${MEMBERLIST_PORT_QUERY_FRONTEND_NODE2}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_1=${MEMBERLIST_PORT_QUERIER_SECONDARY_1}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_2=${MEMBERLIST_PORT_QUERIER_SECONDARY_2}
      - MEMBERLIST_PORT_COMPACTOR_NODE2=${MEMBERLIST_PORT_COMPACTOR_NODE2}
      - QUERY_FRONTEND_GRPC_PORT=${QUERY_FRONTEND_GRPC_PORT}
      - INSTANCE_IP=${INSTANCE_IP}
      - NODE1_IP=${NODE1_IP}
      - NODE2_IP=${NODE2_IP}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_REGION=${S3_REGION}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE}
      - S3_INSECURE=${S3_INSECURE}
      - LOKI_DATA_PATH=${LOKI_DATA_PATH}
      - WAL_PATH=${WAL_PATH}
      - TSDB_PATH=${TSDB_PATH}
      - COMPACTOR_PATH=${COMPACTOR_PATH}
      - REPLICATION_FACTOR=${REPLICATION_FACTOR}
      - CHUNK_IDLE_PERIOD=${CHUNK_IDLE_PERIOD}
      - CHUNK_RETAIN_PERIOD=${CHUNK_RETAIN_PERIOD}
      - MAX_CHUNK_AGE=${MAX_CHUNK_AGE}
      - MAX_CONCURRENT_QUERIES=${MAX_CONCURRENT_QUERIES}
      - QUERY_PARALLELISM=${QUERY_PARALLELISM}
      - MAX_STREAMS_PER_USER=${MAX_STREAMS_PER_USER}
      - MAX_LINE_SIZE=${MAX_LINE_SIZE}
      - MAX_ENTRIES_LIMIT_PER_QUERY=${MAX_ENTRIES_LIMIT_PER_QUERY}
      - LOG_LEVEL=${LOG_LEVEL}
      - LOG_FORMAT=${LOG_FORMAT}
      - AUTH_ENABLED=${AUTH_ENABLED}
      - RING_HEARTBEAT_TIMEOUT=${RING_HEARTBEAT_TIMEOUT}
      - INGESTION_RATE_MB=${INGESTION_RATE_MB}
      - INGESTION_BURST_SIZE_MB=${INGESTION_BURST_SIZE_MB}
      - PER_STREAM_RATE_LIMIT_BYTES=${PER_STREAM_RATE_LIMIT_BYTES}
      - PER_STREAM_RATE_LIMIT_BURST_BYTES=${PER_STREAM_RATE_LIMIT_BURST_BYTES}
      - MAX_QUERY_SERIES=${MAX_QUERY_SERIES}
      - MAX_QUERY_LENGTH=${MAX_QUERY_LENGTH}
      - MAX_QUERY_LOOKBACK=${MAX_QUERY_LOOKBACK}
      - MAX_CACHE_FRESHNESS_PER_QUERY=${MAX_CACHE_FRESHNESS_PER_QUERY}
      - SPLIT_QUERIES_BY_INTERVAL=${SPLIT_QUERIES_BY_INTERVAL}
      - MAX_STREAMS_MATCHERS_PER_QUERY=${MAX_STREAMS_MATCHERS_PER_QUERY}
      - MAX_CONCURRENT_TAIL_REQUESTS=${MAX_CONCURRENT_TAIL_REQUESTS}
      - MAX_GLOBAL_STREAMS_PER_USER=${MAX_GLOBAL_STREAMS_PER_USER}
      - REPLAY_MEMORY_CEILING=${REPLAY_MEMORY_CEILING}
      - QUERY_INGESTERS_WITHIN=${QUERY_INGESTERS_WITHIN}
      - MAX_OUTSTANDING_PER_TENANT=${MAX_OUTSTANDING_PER_TENANT}

  # Loki Compactor
  compactor:
    image: ${LOKI_IMAGE_TAG}
    container_name: loki-compactor-node2
    command: [
      "-config.file=/etc/loki/loki-config.yaml",
      "-config.expand-env=true",
      "-target=compactor"
    ]
    volumes:
      - ./loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - ./data/loki/compactor:/data/loki
#      - /etc/pki/tls/certs/s3store-a9cl2-dr.bank.sbi.crt:/etc/pki/tls/certs/s3store-a9cl2-dr.bank.sbi.crt:ro
      - /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem:/etc/ssl/certs/ca-certificates.crt:ro
      - /root/.aws:/root/.aws:ro
    network_mode: host
    restart: unless-stopped
    environment:
      - HTTP_PORT=${COMPACTOR_HTTP_PORT}
      - GRPC_PORT=${COMPACTOR_GRPC_PORT}
      - MEMBERLIST_PORT=${MEMBERLIST_PORT_COMPACTOR_NODE2}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_1=${MEMBERLIST_PORT_INGESTER_PRIMARY_1}
      - MEMBERLIST_PORT_INGESTER_PRIMARY_2=${MEMBERLIST_PORT_INGESTER_PRIMARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND=${MEMBERLIST_PORT_QUERY_FRONTEND}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_1=${MEMBERLIST_PORT_QUERIER_PRIMARY_1}
      - MEMBERLIST_PORT_QUERIER_PRIMARY_2=${MEMBERLIST_PORT_QUERIER_PRIMARY_2}
      - MEMBERLIST_PORT_COMPACTOR=${MEMBERLIST_PORT_COMPACTOR}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1}
      - MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2=${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_1=${MEMBERLIST_PORT_INGESTER_SECONDARY_1}
      - MEMBERLIST_PORT_INGESTER_SECONDARY_2=${MEMBERLIST_PORT_INGESTER_SECONDARY_2}
      - MEMBERLIST_PORT_QUERY_FRONTEND_NODE2=${MEMBERLIST_PORT_QUERY_FRONTEND_NODE2}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_1=${MEMBERLIST_PORT_QUERIER_SECONDARY_1}
      - MEMBERLIST_PORT_QUERIER_SECONDARY_2=${MEMBERLIST_PORT_QUERIER_SECONDARY_2}
      - MEMBERLIST_PORT_COMPACTOR_NODE2=${MEMBERLIST_PORT_COMPACTOR_NODE2}
      - INSTANCE_IP=${INSTANCE_IP}
      - NODE1_IP=${NODE1_IP}
      - NODE2_IP=${NODE2_IP}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_REGION=${S3_REGION}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE}
      - S3_INSECURE=${S3_INSECURE}
      - LOKI_DATA_PATH=${LOKI_DATA_PATH}
      - WAL_PATH=${WAL_PATH}
      - TSDB_PATH=${TSDB_PATH}
      - COMPACTOR_PATH=${COMPACTOR_PATH}
      - REPLICATION_FACTOR=${REPLICATION_FACTOR}
      - CHUNK_IDLE_PERIOD=${CHUNK_IDLE_PERIOD}
      - CHUNK_RETAIN_PERIOD=${CHUNK_RETAIN_PERIOD}
      - MAX_CHUNK_AGE=${MAX_CHUNK_AGE}
      - MAX_CONCURRENT_QUERIES=${MAX_CONCURRENT_QUERIES}
      - QUERY_PARALLELISM=${QUERY_PARALLELISM}
      - MAX_STREAMS_PER_USER=${MAX_STREAMS_PER_USER}
      - MAX_LINE_SIZE=${MAX_LINE_SIZE}
      - MAX_ENTRIES_LIMIT_PER_QUERY=${MAX_ENTRIES_LIMIT_PER_QUERY}
      - LOG_LEVEL=${LOG_LEVEL}
      - LOG_FORMAT=${LOG_FORMAT}
      - AUTH_ENABLED=${AUTH_ENABLED}
      - RING_HEARTBEAT_TIMEOUT=${RING_HEARTBEAT_TIMEOUT}
      - INGESTION_RATE_MB=${INGESTION_RATE_MB}
      - INGESTION_BURST_SIZE_MB=${INGESTION_BURST_SIZE_MB}
      - PER_STREAM_RATE_LIMIT_BYTES=${PER_STREAM_RATE_LIMIT_BYTES}
      - PER_STREAM_RATE_LIMIT_BURST_BYTES=${PER_STREAM_RATE_LIMIT_BURST_BYTES}
      - MAX_QUERY_SERIES=${MAX_QUERY_SERIES}
      - MAX_QUERY_LENGTH=${MAX_QUERY_LENGTH}
      - MAX_QUERY_LOOKBACK=${MAX_QUERY_LOOKBACK}
      - MAX_CACHE_FRESHNESS_PER_QUERY=${MAX_CACHE_FRESHNESS_PER_QUERY}
      - SPLIT_QUERIES_BY_INTERVAL=${SPLIT_QUERIES_BY_INTERVAL}
      - MAX_STREAMS_MATCHERS_PER_QUERY=${MAX_STREAMS_MATCHERS_PER_QUERY}
      - MAX_CONCURRENT_TAIL_REQUESTS=${MAX_CONCURRENT_TAIL_REQUESTS}
      - MAX_GLOBAL_STREAMS_PER_USER=${MAX_GLOBAL_STREAMS_PER_USER}
      - REPLAY_MEMORY_CEILING=${REPLAY_MEMORY_CEILING}
      - QUERY_INGESTERS_WITHIN=${QUERY_INGESTERS_WITHIN}
      - MAX_OUTSTANDING_PER_TENANT=${MAX_OUTSTANDING_PER_TENANT}

  # Prometheus for monitoring
  prometheus:
    image: ${PROMETHEUS_IMAGE_TAG}
    container_name: prometheus-node2
    network_mode: host
    volumes:
      - ./data/prometheus:/data/prometheus
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./observe/grafana/alerts:/etc/prometheus/alerts:ro
    restart: unless-stopped
    command:
      - '--web.listen-address=0.0.0.0:${PROMETHEUS_PORT}'
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/data/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION_DAYS}d'
      - '--storage.tsdb.retention.size=${PROMETHEUS_RETENTION_SIZE}'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
[root@drlogging2 node2]# cat loki-config.yaml
# =============================================================================
# LOKI PRODUCTION CONFIGURATION - NODE 2
# =============================================================================
# High availability configuration with NetAPP S3 storage

server:
  http_listen_port: ${HTTP_PORT}
  grpc_listen_port: ${GRPC_PORT}
  log_level: ${LOG_LEVEL}
  log_format: ${LOG_FORMAT}

  # Increase gRPC message size limits (default 4MiB)
  grpc_server_max_recv_msg_size: 104857600   # 100 MB
  grpc_server_max_send_msg_size: 104857600   # 100 MB
  http_server_read_timeout: 1m
  http_server_write_timeout: 1m

auth_enabled: ${AUTH_ENABLED}

# Common configuration
common:
  path_prefix: ${LOKI_DATA_PATH}
  replication_factor: ${REPLICATION_FACTOR}
  compactor_grpc_address: "${INSTANCE_IP}:${COMPACTOR_GRPC_PORT}"
  ring:
    kvstore:
      store: memberlist

# Memberlist configuration for clustering
memberlist:
  advertise_addr: "${INSTANCE_IP}"        # <- ensure others see the routable IP
  advertise_port: ${MEMBERLIST_PORT}      # <- per-container env already unique
  join_members:
    - "${NODE1_IP}:${MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1}"   # 10.177.139.191:7946
    - "${NODE2_IP}:${MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1}" # 10.177.139.192:7957
  bind_port: ${MEMBERLIST_PORT}

# NetAPP S3 storage configuration
storage_config:
  tsdb_shipper:
    active_index_directory: ${TSDB_PATH}/index
    cache_location: ${TSDB_PATH}/cache
  aws:
    endpoint: ${S3_ENDPOINT}
    region: ${S3_REGION}
    bucketnames: ${S3_BUCKET}
    access_key_id: ${S3_ACCESS_KEY}
    secret_access_key: ${S3_SECRET_KEY}
    s3forcepathstyle: ${S3_FORCE_PATH_STYLE}
    insecure: ${S3_INSECURE}

# Schema configuration
schema_config:
  configs:
    - from: 2020-10-24
      store: tsdb
      object_store: aws
      schema: v13
      index:
        prefix: index_
        period: 24h

# Distributor configuration
distributor:
  ring:
    kvstore:
      store: memberlist
    heartbeat_timeout: ${RING_HEARTBEAT_TIMEOUT}

# Ingester configuration
ingester:
  lifecycler:
    address: "${INSTANCE_IP}"
    ring:
      kvstore:
        store: memberlist
      replication_factor: ${REPLICATION_FACTOR}
      heartbeat_timeout: ${RING_HEARTBEAT_TIMEOUT}
    final_sleep: 30s
    min_ready_duration: 30s
    port: ${GRPC_PORT}
    id: "${INSTANCE_IP}:${GRPC_PORT}"
  chunk_idle_period: ${CHUNK_IDLE_PERIOD}
  chunk_retain_period: ${CHUNK_RETAIN_PERIOD}
  max_chunk_age: ${MAX_CHUNK_AGE}
  wal:
    enabled: true
    dir: ${WAL_PATH}
    checkpoint_duration: 10m
    flush_on_shutdown: true
    replay_memory_ceiling: ${REPLAY_MEMORY_CEILING}

# Querier configuration
querier:
  max_concurrent: ${MAX_CONCURRENT_QUERIES}
  query_ingesters_within: ${QUERY_INGESTERS_WITHIN}

# Query range configuration
query_range:
  align_queries_with_step: true
  cache_results: false

# Query-frontend configuration
frontend:
  address: "localhost:${QUERY_FRONTEND_HTTP_PORT}"
  max_outstanding_per_tenant: ${MAX_OUTSTANDING_PER_TENANT}
  log_queries_longer_than: 5s
  compress_responses: true

# Frontend worker configuration
frontend_worker:
  frontend_address: "${INSTANCE_IP}:${QUERY_FRONTEND_GRPC_PORT}"

# Compactor configuration
compactor:
  working_directory: ${COMPACTOR_PATH}
  compaction_interval: 10m
  retention_enabled: false

# Limits configuration
limits_config:
  reject_old_samples: true
  reject_old_samples_max_age: 168h
  max_streams_per_user: ${MAX_STREAMS_PER_USER}
  max_line_size: ${MAX_LINE_SIZE}
  max_entries_limit_per_query: ${MAX_ENTRIES_LIMIT_PER_QUERY}
  max_query_series: ${MAX_QUERY_SERIES}
  max_query_parallelism: ${QUERY_PARALLELISM}
  max_query_length: ${MAX_QUERY_LENGTH}
  max_query_lookback: ${MAX_QUERY_LOOKBACK}
  max_cache_freshness_per_query: ${MAX_CACHE_FRESHNESS_PER_QUERY}
  split_queries_by_interval: ${SPLIT_QUERIES_BY_INTERVAL}
  per_stream_rate_limit: ${PER_STREAM_RATE_LIMIT_BYTES}
  per_stream_rate_limit_burst: ${PER_STREAM_RATE_LIMIT_BURST_BYTES}
  max_streams_matchers_per_query: ${MAX_STREAMS_MATCHERS_PER_QUERY}
  max_concurrent_tail_requests: ${MAX_CONCURRENT_TAIL_REQUESTS}
  max_global_streams_per_user: ${MAX_GLOBAL_STREAMS_PER_USER}
  ingestion_rate_mb: ${INGESTION_RATE_MB}
  ingestion_burst_size_mb: ${INGESTION_BURST_SIZE_MB}
[root@drlogging2 node2]# cat .env
# =============================================================================
# NODE 2 CONFIGURATION - STANDARD PORTS
# =============================================================================

# Docker Image Tags
LOKI_IMAGE_TAG=grafana/loki:3.5.5
PROMETHEUS_IMAGE_TAG=prom/prometheus:v3.5.0
REDIS_IMAGE_TAG=redis/redis-7:9.6

# Instance Configuration
INSTANCE_IP=10.177.139.192
NODE1_IP=10.177.139.191
NODE2_IP=10.177.139.192

# S3 Configuration
S3_ENDPOINT=https://10.176.58.215
S3_REGION=us-east-1
S3_BUCKET=epay-dr-preprod-external-logging
S3_ACCESS_KEY=ISDFM17568E29GK2XFUB
S3_SECRET_KEY=mSXxF48x12V_p___45ne_TYqQaPeC3Nrg_a1_V_4

# Redis Configuration
REDIS_PORT=6380
REDIS_PASSWORD=redis
REDIS_MAX_MEMORY=2gb
REDIS_MAX_MEMORY_POLICY=allkeys-lru

# Loki Configuration
REPLICATION_FACTOR=2
MAX_ENTRIES_LIMIT_PER_QUERY=5000
LOG_LEVEL=info
LOG_FORMAT=json
AUTH_ENABLED=false

# Data Paths
LOKI_DATA_PATH=/data/loki
WAL_PATH=/data/loki/wal
TSDB_PATH=/data/loki/tsdb
COMPACTOR_PATH=/data/loki/compactor

# =============================================================================
# STANDARD HTTP PORTS (Same for both nodes)
# =============================================================================

# Distributor Ports
DISTRIBUTOR_SECONDARY_1_HTTP_PORT=3100
DISTRIBUTOR_SECONDARY_2_HTTP_PORT=3101

# Ingester Ports
INGESTER_SECONDARY_1_HTTP_PORT=3102
INGESTER_SECONDARY_2_HTTP_PORT=3103

# Query Frontend Ports
QUERY_FRONTEND_HTTP_PORT=3104

# Querier Ports
QUERIER_SECONDARY_1_HTTP_PORT=3105
QUERIER_SECONDARY_2_HTTP_PORT=3106

# Compactor Ports
COMPACTOR_HTTP_PORT=3107

# Prometheus Port (Standard)
PROMETHEUS_PORT=9090

# =============================================================================
# STANDARD GRPC PORTS (Same for both nodes)
# =============================================================================

# Distributor gRPC Ports
DISTRIBUTOR_SECONDARY_1_GRPC_PORT=9100
DISTRIBUTOR_SECONDARY_2_GRPC_PORT=9101

# Ingester gRPC Ports
INGESTER_SECONDARY_1_GRPC_PORT=9102
INGESTER_SECONDARY_2_GRPC_PORT=9103

# Querier gRPC Ports
QUERIER_SECONDARY_1_GRPC_PORT=9104
QUERIER_SECONDARY_2_GRPC_PORT=9105

# Query Frontend GRPC Ports
QUERY_FRONTEND_GRPC_PORT=9106

# Compactor GRPC Ports
COMPACTOR_GRPC_PORT=9107

# =============================================================================
# UNIQUE MEMBERLIST PORTS (Different for each replica)
# =============================================================================

# Base memberlist port (used by Loki config bind_port)
MEMBERLIST_PORT=7954

# Node 2 Memberlist Ports
MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_1=7954
MEMBERLIST_PORT_DISTRIBUTOR_SECONDARY_2=7955
MEMBERLIST_PORT_INGESTER_SECONDARY_1=7956
MEMBERLIST_PORT_INGESTER_SECONDARY_2=7957
MEMBERLIST_PORT_QUERY_FRONTEND_NODE2=7958
MEMBERLIST_PORT_QUERIER_SECONDARY_1=7959
MEMBERLIST_PORT_QUERIER_SECONDARY_2=7960
MEMBERLIST_PORT_COMPACTOR_NODE2=7961

# Node 1 Memberlist Ports (for discovery)
MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_1=7946
MEMBERLIST_PORT_DISTRIBUTOR_PRIMARY_2=7947
MEMBERLIST_PORT_INGESTER_PRIMARY_1=7948
MEMBERLIST_PORT_INGESTER_PRIMARY_2=7949
MEMBERLIST_PORT_QUERY_FRONTEND=7950
MEMBERLIST_PORT_QUERIER_PRIMARY_1=7951
MEMBERLIST_PORT_QUERIER_PRIMARY_2=7952
MEMBERLIST_PORT_COMPACTOR=7953

# Prometheus Configuration
PROMETHEUS_RETENTION_DAYS=15
PROMETHEUS_RETENTION_SIZE=1GB

# S3 Configuration
S3_FORCE_PATH_STYLE=true
S3_INSECURE=false

# Loki Performance Tuning
CHUNK_IDLE_PERIOD=15m
CHUNK_RETAIN_PERIOD=30m
MAX_CHUNK_AGE=30m
MAX_CONCURRENT_QUERIES=100
QUERY_PARALLELISM=64
MAX_STREAMS_PER_USER=100000
MAX_LINE_SIZE=1048576

# =============================================================================
# INGESTION RATE LIMITS (Increased for High Volume)
# =============================================================================

# Global ingestion rate limits
INGESTION_RATE_MB=64
INGESTION_BURST_SIZE_MB=128

# Per-stream rate limits
PER_STREAM_RATE_LIMIT_BYTES=10485760
PER_STREAM_RATE_LIMIT_BURST_BYTES=52428800

# Ring heartbeat timeout
RING_HEARTBEAT_TIMEOUT=1m

# =============================================================================
# PRODUCTION-GRADE PERFORMANCE LIMITS (High Volume & Burst)
# =============================================================================

# Chunk Management (Optimized for high volume)
REPLAY_MEMORY_CEILING=4GB

# Query Performance (High concurrency)
MAX_QUERY_SERIES=500000
MAX_ENTRIES_LIMIT_PER_QUERY=20000

# Stream Limits (High volume applications)
MAX_GLOBAL_STREAMS_PER_USER=100000
MAX_STREAMS_MATCHERS_PER_QUERY=5000

# Real-time Limits (Live monitoring)
MAX_CONCURRENT_TAIL_REQUESTS=100
MAX_CACHE_FRESHNESS_PER_QUERY=5m

# Network Limits (High concurrency)
MAX_OUTSTANDING_PER_TENANT=1024
QUERY_INGESTERS_WITHIN=6h

# Query Optimization
MAX_QUERY_LENGTH=720h
MAX_QUERY_LOOKBACK=720h
SPLIT_QUERIES_BY_INTERVAL=5m


[root@drlogging2 node2]# cat prometheus.yml
# =============================================================================
# PROMETHEUS PRODUCTION CONFIGURATION - NODE 2 HA (FIXED)
# =============================================================================
# Hardcoded configuration for Node 2 with HA replicas

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: loki-multi-node-ha
    environment: production
    datacenter: node2

# Alerting configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - 127.0.0.1:9093

rule_files:
  - "rules/*.yml"
  - "/etc/prometheus/alerts/*.yml"

scrape_configs:
  # Loki Distributor Secondary 1 - Node 2
  - job_name: 'loki-distributor-secondary-1-node2'
    static_configs:
      - targets:
        - 'loki-distributor-secondary-1-node2:3100'
    metrics_path: '/metrics'
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'node'
        replacement: 'node2'
      - source_labels: [__address__]
        target_label: 'component'
        replacement: 'distributor'
      - source_labels: [__address__]
        target_label: 'replica'
        replacement: 'secondary-1'

  # Loki Distributor Secondary 2 - Node 2
  - job_name: 'loki-distributor-secondary-2-node2'
    static_configs:
      - targets:
        - 'loki-distributor-secondary-2-node2:3101'
    metrics_path: '/metrics'
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'node'
        replacement: 'node2'
      - source_labels: [__address__]
        target_label: 'component'
        replacement: 'distributor'
      - source_labels: [__address__]
        target_label: 'replica'
        replacement: 'secondary-2'

  # Loki Ingester Secondary 1 - Node 2
  - job_name: 'loki-ingester-secondary-1-node2'
    static_configs:
      - targets:
        - 'loki-ingester-secondary-1-node2:3102'
    metrics_path: '/metrics'
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'node'
        replacement: 'node2'
      - source_labels: [__address__]
        target_label: 'component'
        replacement: 'ingester'
      - source_labels: [__address__]
        target_label: 'replica'
        replacement: 'secondary-1'

  # Loki Ingester Secondary 2 - Node 2
  - job_name: 'loki-ingester-secondary-2-node2'
    static_configs:
      - targets:
        - 'loki-ingester-secondary-2-node2:3103'
    metrics_path: '/metrics'
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'node'
        replacement: 'node2'
      - source_labels: [__address__]
        target_label: 'component'
        replacement: 'ingester'
      - source_labels: [__address__]
        target_label: 'replica'
        replacement: 'secondary-2'

  # Loki Query Frontend - Node 2
  - job_name: 'loki-query-frontend-node2'
    static_configs:
      - targets:
        - 'loki-query-frontend-node2:3104'
    metrics_path: '/metrics'
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'node'
        replacement: 'node2'
      - source_labels: [__address__]
        target_label: 'component'
        replacement: 'query-frontend'

  # Loki Querier Secondary 1 - Node 2
  - job_name: 'loki-querier-secondary-1-node2'
    static_configs:
      - targets:
        - 'loki-querier-secondary-1-node2:3105'
    metrics_path: '/metrics'
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'node'
        replacement: 'node2'
      - source_labels: [__address__]
        target_label: 'component'
        replacement: 'querier'
      - source_labels: [__address__]
        target_label: 'replica'
        replacement: 'secondary-1'

  # Loki Querier Secondary 2 - Node 2
  - job_name: 'loki-querier-secondary-2-node2'
    static_configs:
      - targets:
        - 'loki-querier-secondary-2-node2:3106'
    metrics_path: '/metrics'
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'node'
        replacement: 'node2'
      - source_labels: [__address__]
        target_label: 'component'
        replacement: 'querier'
      - source_labels: [__address__]
        target_label: 'replica'
        replacement: 'secondary-2'

  # Loki Compactor - Node 2
  - job_name: 'loki-compactor-node2'
    static_configs:
      - targets:
        - 'loki-compactor-node2:3207'
    metrics_path: '/metrics'
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'node'
        replacement: 'node2'
      - source_labels: [__address__]
        target_label: 'component'
        replacement: 'compactor'

  # Prometheus self-monitoring - Node 2
  - job_name: 'prometheus-node2'
    static_configs:
      - targets:
        - 127.0.0.1:9090
    metrics_path: '/metrics'
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'node'
        replacement: 'node2'
      - source_labels: [__address__]
        target_label: 'component'
        replacement: 'prometheus'

  # Redis - Node 2
  - job_name: 'redis-node2'
    static_configs:
      - targets:
        - 127.0.0.1:6376
    metrics_path: '/metrics'
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'node'
        replacement: 'node2'
      - source_labels: [__address__]
        target_label: 'component'
        replacement: 'redis'

  # Grafana
  - job_name: 'grafana'
    static_configs:
      - targets:
        - 127.0.0.1:3000
    metrics_path: '/metrics'
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'node'
        replacement: 'observe'
      - source_labels: [__address__]
        target_label: 'component'
        replacement: 'grafana'

  # AlertManager
  - job_name: 'alertmanager'
    static_configs:
      - targets:
        - 127.0.0.1:9093
    metrics_path: '/metrics'
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'node'
        replacement: 'observe'
      - source_labels: [__address__]
        target_label: 'component'
        replacement: 'alertmanager'
